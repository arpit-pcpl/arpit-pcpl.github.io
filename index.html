<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Speechmatics Flow Agent Chat</title>
</head>
<body>
  <h2>ðŸŽ¤ Speechmatics Flow - Agent Conversation</h2>
  <button id="start">Start Conversation</button>
  <button id="stop" disabled>Stop</button>
  <pre id="output"></pre>

  <script>
    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");
    const output = document.getElementById("output");

    const jwt = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzbWlzc3VlciIsImF1ZCI6WyJldSJdLCJleHAiOjE3NDk4Mzc4MjIsIm5iZiI6MTc0OTgzNDE2MiwiaWF0IjoxNzQ5ODM3NzYyLCJjb250cmFjdF9pZCI6IjE2NjcxNiIsInByb2plY3RfaWQiOiIxNjY3MTYiLCJwcm9kdWN0IjoiZmxvdyIsInVzZXJfaWQiOiJzZWxmc2VydmljZS0xNjY3MTciLCJhY2NvdW50X3R5cGUiOiJmcmVlIiwiY29ubmVjdGlvbl9xdW90YSI6IjMifQ.g39m9giKP3tTkr0SIjvq3aXeM36gqGYxk9Bj3zAOAxoRPhvQ-rg8QFHKxvnPxkJzWlqURuVE2XDcsZ2WwN9_zZuxPFPd4tG0dkPxadijsKV54I9_Js0gnl8Ruu9pMKL8BS1a-tnx9bfoCu1OsFJxJVGvDwMmqozKNLwVAmMlbv83QHa_Mh05bjU5kN64i9rBa71U9Go14YtRVwp8L6oW8Glu_kdsSQEl-BHP0n0A4d1kou1MOZS-R87vhdPhnjgwO1bJx565SspfKN3sfdiiz3RP_iZCghU-dNz8kAjCOyrt0-7viv-dWTwbiADncRr1U26holwAj0qxwYpoIwoFO9So-R5imFPwlYy8FN9hKFimBM5XqsTrY26JwjLyhmey-LZYUuQPeF2_qViALuNc9qesh7KGNAst9hh8ZivOZfA6PFWdw4lcDVTPbAcDY8LsxVQfeMf8aIAGT7F6uWvk9EyZR40bCtOpjvnevZddBQ0F-3AJbA8HyT6lZ9CjJWzY"; // ðŸ‘ˆ Replace this with your temporary JWT
    const WS_URL = `wss://flow.api.speechmatics.com/v1/flow?jwt=${jwt}`;

    let ws, audioContext, processor, input, stream;

    function log(msg) {
      output.textContent += msg + '\n';
    }

    startBtn.onclick = async () => {
      startBtn.disabled = true;
      stopBtn.disabled = false;

      log("ðŸ”Œ Connecting to Speechmatics Flow...");
      ws = new WebSocket(WS_URL);
      ws.binaryType = "arraybuffer";

      ws.onopen = async () => {
        log("âœ… WebSocket connected");

        ws.send(JSON.stringify({
          message: "StartConversation",
          audio_format: {
            type: "raw",
            encoding: "pcm_f32le",
            sample_rate: 44100
          },
          conversation_config: {
            template_id: "default",
            template_variables: {
              persona: "You are an aging English rock star named Goder Rogfrey.",
              style: "Be charming but unpredictable. Take any opportunity you can to talk about the old days of rock'n'roll. If there are multiple speakers, get them to be sassy to each other.",
              context: "You are taking a customer's order for fast food at the Soft Pebble Cafe. The only options on the menu are burgers and chicken nuggets. Please make them sound appealing!"
            }
          },
          tools: {
            type: "function",
            function: {
              name: "function_call_name",
              description: "Function call trigger.",
              parameters: {
                type: "object",
                properties: {
                  param_name: { type: "string", description: "Parameter description." },
                  another_param_name: { type: "string", description: "Another parameter description." }
                },
                required: ["param_name"]
              }
            }
          },
          debug: {
            llm: true
          }
        }));

        // Start audio
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new AudioContext({ sampleRate: 44100 });
        input = audioContext.createMediaStreamSource(stream);
        processor = audioContext.createScriptProcessor(4096, 1, 1);

        processor.onaudioprocess = e => {
          const float32Data = e.inputBuffer.getChannelData(0);
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(float32Data.buffer);
          }
        };

        input.connect(processor);
        processor.connect(audioContext.destination);
      };

      ws.onmessage = event => {
        const data = JSON.parse(event.data);
        if (data.message === "Transcript") {
          const msg = data?.transcript?.alternatives?.[0]?.content;
          if (msg) log("ðŸ—£ï¸ " + msg);
        } else {
          log("ðŸ“© " + JSON.stringify(data));
        }
      };

      ws.onerror = (err) => log("âŒ WebSocket error: " + err.message);
      ws.onclose = () => log("ðŸ”Œ Connection closed");
    };

    stopBtn.onclick = () => {
      startBtn.disabled = false;
      stopBtn.disabled = true;
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
      }
      if (processor) processor.disconnect();
      if (input) input.disconnect();
      if (audioContext) audioContext.close();
      if (stream) stream.getTracks().forEach(t => t.stop());
      log("ðŸ›‘ Stopped conversation.");
    };
  </script>
</body>
</html>
